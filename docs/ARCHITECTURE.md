# ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## ğŸ“ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Universal Remote Control                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   æ§åˆ¶ç«¯è®¾å¤‡      â”‚              â”‚   è¢«æ§ç«¯è®¾å¤‡      â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  UI Layer        â”‚              â”‚  UI Layer        â”‚    â”‚
â”‚  â”‚  â”œâ”€ Home Page    â”‚              â”‚  â”œâ”€ Home Page    â”‚    â”‚
â”‚  â”‚  â”œâ”€ Device List  â”‚              â”‚  â””â”€ Controlled   â”‚    â”‚
â”‚  â”‚  â”œâ”€ Controller   â”‚              â”‚      Page        â”‚    â”‚
â”‚  â”‚  â””â”€ Widgets      â”‚              â”‚                  â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  Service Layer   â”‚              â”‚  Service Layer   â”‚    â”‚
â”‚  â”‚  â”œâ”€ Capture      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”œâ”€ Simulator    â”‚    â”‚
â”‚  â”‚  â”‚   Service     â”‚  WebSocket   â”‚  â”‚   Service     â”‚    â”‚
â”‚  â”‚  â”œâ”€ WebSocket    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”œâ”€ WebSocket    â”‚    â”‚
â”‚  â”‚  â”‚   Client      â”‚              â”‚  â”‚   Server      â”‚    â”‚
â”‚  â”‚  â””â”€ Discovery    â”‚              â”‚  â””â”€ Discovery    â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  Core Layer      â”‚              â”‚  Core Layer      â”‚    â”‚
â”‚  â”‚  â”œâ”€ Protocol     â”‚              â”‚  â”œâ”€ Protocol     â”‚    â”‚
â”‚  â”‚  â””â”€ Models       â”‚              â”‚  â””â”€ Models       â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  Native Layer    â”‚              â”‚  Native Layer    â”‚    â”‚
â”‚  â”‚  â””â”€ Sensors      â”‚              â”‚  â””â”€ Input        â”‚    â”‚
â”‚  â”‚     (Gyro)       â”‚              â”‚     Simulation   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ å±‚çº§ç»“æ„

### 1. UIå±‚ (`lib/ui/`)

è´Ÿè´£ç”¨æˆ·ç•Œé¢å±•ç¤ºå’Œäº¤äº’ã€‚

#### é¡µé¢ (Pages)
- **HomePage**: ä¸»é¡µï¼Œæ¨¡å¼é€‰æ‹©
- **DeviceListPage**: è®¾å¤‡æ‰«æå’Œé€‰æ‹©
- **ControllerPage**: æ§åˆ¶ç«¯ç•Œé¢
- **ControlledPage**: è¢«æ§ç«¯ç•Œé¢

#### ç»„ä»¶ (Widgets)
- **VirtualTouchpad**: è™šæ‹Ÿè§¦æ‘¸æ¿
- **GyroController**: é™€èºä»ªæ§åˆ¶å™¨
- **VirtualKeyboard**: è™šæ‹Ÿé”®ç›˜ï¼ˆå¾…å®ç°ï¼‰

### 2. æœåŠ¡å±‚ (`lib/services/`)

è´Ÿè´£æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚

#### WebSocketService
- ç®¡ç†WebSocketè¿æ¥
- å‘é€å’Œæ¥æ”¶äº‹ä»¶
- å¿ƒè·³ç»´æŠ¤
- çŠ¶æ€ç®¡ç†

#### InputCaptureService (æ§åˆ¶ç«¯)
- æ•è·é™€èºä»ªæ•°æ®
- å¤„ç†è§¦æ‘¸è¾“å…¥
- è½¬æ¢ä¸ºæ ‡å‡†äº‹ä»¶
- çµæ•åº¦è°ƒèŠ‚

#### InputSimulatorService (è¢«æ§ç«¯)
- æ¥æ”¶æ§åˆ¶äº‹ä»¶
- è°ƒç”¨åŸç”Ÿè¾“å…¥æ¨¡æ‹Ÿ
- è·¨å¹³å°é€‚é…

### 3. æ ¸å¿ƒå±‚ (`lib/core/`)

æä¾›é€šç”¨åŠŸèƒ½å’Œåè®®ã€‚

#### Protocol
- äº‹ä»¶ç¼–è§£ç 
- æ¡æ‰‹åè®®
- å¿ƒè·³æ¶ˆæ¯
- é”™è¯¯å¤„ç†

#### DeviceDiscovery
- UDPå¹¿æ’­
- è®¾å¤‡å‘ç°
- è®¾å¤‡åˆ—è¡¨ç®¡ç†
- è¿‡æœŸè®¾å¤‡æ¸…ç†

### 4. æ¨¡å‹å±‚ (`lib/models/`)

å®šä¹‰æ•°æ®ç»“æ„ã€‚

#### ControlEvent
- äº‹ä»¶ç±»å‹å®šä¹‰
- äº‹ä»¶å·¥å‚æ–¹æ³•
- JSONåºåˆ—åŒ–

#### DeviceInfo
- è®¾å¤‡ä¿¡æ¯
- è®¾å¤‡ç±»å‹
- è®¾å¤‡æ¨¡å¼

#### ConnectionState
- è¿æ¥çŠ¶æ€
- çŠ¶æ€è½¬æ¢
- çŠ¶æ€æŸ¥è¯¢

### 5. åŸç”Ÿå±‚ (`native/`)

å¹³å°ç‰¹å®šå®ç°ã€‚

#### Windows (C++)
- Win32 API
- SendInputå‡½æ•°
- é¼ æ ‡é”®ç›˜æ¨¡æ‹Ÿ

#### Linux (C++)
- X11/XTest
- è¾“å…¥äº‹ä»¶æ¨¡æ‹Ÿ
- è·¨å‘è¡Œç‰ˆå…¼å®¹

#### macOS (C++)
- CoreGraphics
- Quartz Event Services
- è¾…åŠ©åŠŸèƒ½æƒé™

#### Android (Kotlin)
- AccessibilityService
- æ‰‹åŠ¿æ¨¡æ‹Ÿ
- æƒé™ç®¡ç†

---

## ğŸ”„ æ•°æ®æµ

### æ§åˆ¶ç«¯ â†’ è¢«æ§ç«¯

```
ç”¨æˆ·äº¤äº’
   â†“
UIç»„ä»¶ (VirtualTouchpad/GyroController)
   â†“
InputCaptureService.sendXXX()
   â†“
åˆ›å»º ControlEvent
   â†“
WebSocketService.sendEvent()
   â†“
Protocol.encodeEvent()
   â†“
WebSocketç½‘ç»œä¼ è¾“
   â†“
[è¢«æ§ç«¯] WebSocketService.eventStream
   â†“
InputSimulatorService.handleEvent()
   â†“
è°ƒç”¨åŸç”Ÿåº“ (FFI)
   â†“
æ“ä½œç³»ç»Ÿè¾“å…¥äº‹ä»¶
```

### è®¾å¤‡å‘ç°æµç¨‹

```
[è¢«æ§ç«¯] DeviceDiscovery.start()
   â†“
å¹¿æ’­è®¾å¤‡ä¿¡æ¯ (UDP)
   â†“
[æ§åˆ¶ç«¯] DeviceDiscoveryç›‘å¬
   â†“
è§£æè®¾å¤‡ä¿¡æ¯
   â†“
æ›´æ–°è®¾å¤‡åˆ—è¡¨
   â†“
UIæ˜¾ç¤ºå¯ç”¨è®¾å¤‡
```

---

## ğŸ”Œ é€šä¿¡åè®®

### WebSocketè¿æ¥

- **ç«¯å£**: 9877 (é»˜è®¤)
- **åè®®**: ws:// (æœªåŠ å¯†)
- **æ•°æ®æ ¼å¼**: JSON

### UDPå¹¿æ’­

- **ç«¯å£**: 9876
- **åœ°å€**: 255.255.255.255
- **é¢‘ç‡**: æ¯2ç§’ä¸€æ¬¡

### äº‹ä»¶åè®®

```json
{
  "type": "event",
  "subtype": "mouse_move",
  "timestamp": 1234567890,
  "data": {
    "dx": 5,
    "dy": -3
  }
}
```

---

## ğŸ§© æ¨¡å—ä¾èµ–å…³ç³»

```
UI Layer
   â†“ depends on
Service Layer
   â†“ depends on
Core Layer
   â†“ depends on
Models Layer
   â†“ depends on
Native Layer (FFI)
```

### å…³é”®ä¾èµ–

- **UI â†’ Service**: Provideræ³¨å…¥
- **Service â†’ Core**: ç›´æ¥å¯¼å…¥
- **Service â†’ Native**: FFIç»‘å®š
- **All â†’ Models**: æ•°æ®æ¨¡å‹

---

## ğŸ” å®‰å…¨è€ƒè™‘

### å½“å‰å®ç°
- âœ… å±€åŸŸç½‘é™åˆ¶
- âœ… è®¾å¤‡IDéªŒè¯
- âš ï¸ æ— åŠ å¯†ä¼ è¾“
- âš ï¸ æ— èº«ä»½è®¤è¯

### æ”¹è¿›æ–¹å‘
- ğŸ”² SSL/TLSåŠ å¯†
- ğŸ”² å¯†ç /PINä¿æŠ¤
- ğŸ”² è®¾å¤‡ç™½åå•
- ğŸ”² æ“ä½œæ—¥å¿—

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### å·²å®ç°
- é«˜é¢‘äº‹ä»¶é‡‡æ ·ï¼ˆé™€èºä»ªï¼‰
- å¿ƒè·³æœºåˆ¶ï¼ˆå‡å°‘ä¸å¿…è¦é€šä¿¡ï¼‰
- äº‹ä»¶æ‰¹å¤„ç†ï¼ˆå¾…ä¼˜åŒ–ï¼‰

### å¾…ä¼˜åŒ–
- UDPæ›¿ä»£WebSocketï¼ˆé™ä½å»¶è¿Ÿï¼‰
- å·®åˆ†ä¼ è¾“ï¼ˆå‡å°‘æ•°æ®é‡ï¼‰
- æœ¬åœ°é¢„æµ‹ï¼ˆè¡¥å¿ç½‘ç»œå»¶è¿Ÿï¼‰

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- æ¨¡å‹ç±»åºåˆ—åŒ–/ååºåˆ—åŒ–
- åè®®ç¼–è§£ç 
- äº‹ä»¶è½¬æ¢

### é›†æˆæµ‹è¯•
- è®¾å¤‡å‘ç°
- WebSocketè¿æ¥
- äº‹ä»¶ä¼ è¾“

### ç«¯åˆ°ç«¯æµ‹è¯•
- å®Œæ•´æ§åˆ¶æµç¨‹
- å¤šè®¾å¤‡è¿æ¥
- å¼‚å¸¸æ¢å¤

---

## ğŸ“Š çŠ¶æ€ç®¡ç†

ä½¿ç”¨ **Provider** è¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼š

```dart
MultiProvider(
  providers: [
    Provider<WebSocketService>(...),
    Provider<InputCaptureService>(...),
    Provider<InputSimulatorService>(...),
    Provider<DeviceDiscovery>(...),
  ],
  child: MaterialApp(...),
)
```

---

## ğŸ› ï¸ æ‰©å±•ç‚¹

### æ·»åŠ æ–°çš„è¾“å…¥ç±»å‹

1. åœ¨ `ControlEvent` ä¸­æ·»åŠ æ–°çš„äº‹ä»¶ç±»å‹
2. åœ¨ `InputCaptureService` ä¸­å®ç°æ•è·
3. åœ¨ `InputSimulatorService` ä¸­å®ç°æ¨¡æ‹Ÿ
4. åœ¨UIä¸­æ·»åŠ æ§åˆ¶ç•Œé¢

### æ·»åŠ æ–°å¹³å°æ”¯æŒ

1. åœ¨ `native/` ä¸‹åˆ›å»ºå¹³å°ç›®å½•
2. å®ç°è¾“å…¥æ¨¡æ‹Ÿæ¥å£
3. åœ¨ `InputSimulatorService` ä¸­æ·»åŠ FFIç»‘å®š
4. æ›´æ–°æ„å»ºè„šæœ¬

### æ·»åŠ æ–°åŠŸèƒ½

1. æ–‡ä»¶ä¼ è¾“
2. å‰ªè´´æ¿åŒæ­¥
3. å±å¹•å…±äº«
4. è¯­éŸ³æ§åˆ¶

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Flutteræ¶æ„æŒ‡å—](https://flutter.dev/docs/development/data-and-backend/state-mgmt/intro)
- [WebSocketåè®®](https://tools.ietf.org/html/rfc6455)
- [UDPå¹¿æ’­](https://en.wikipedia.org/wiki/Broadcasting_(networking))
- [Dart FFI](https://dart.dev/guides/libraries/c-interop)

