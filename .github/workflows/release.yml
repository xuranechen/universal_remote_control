name: Release Build

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  # åˆ›å»ºRelease
  create-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi
    
    - name: åˆ›å»ºRelease
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: Universal Remote Control v${{ steps.get_version.outputs.version }}
        body: |
          ## ğŸ‰ Universal Remote Control v${{ steps.get_version.outputs.version }}
          
          ### ğŸ“¦ ä¸‹è½½
          
          - **Windows**: `universal_remote_control_windows_v${{ steps.get_version.outputs.version }}.zip`
          - **Linux**: `universal_remote_control_linux_v${{ steps.get_version.outputs.version }}.tar.gz`
          - **macOS**: `universal_remote_control_macos_v${{ steps.get_version.outputs.version }}.zip`
          - **Android APK**: `universal_remote_control_v${{ steps.get_version.outputs.version }}.apk`
          
          ### âœ¨ æ–°ç‰¹æ€§
          
          - è·¨å¹³å°è¿œç¨‹æ§åˆ¶
          - é™€èºä»ªé£é¼ åŠŸèƒ½
          - è™šæ‹Ÿè§¦æ‘¸æ¿
          - è‡ªåŠ¨è®¾å¤‡å‘ç°
          
          ### ğŸ“– ä½¿ç”¨è¯´æ˜
          
          è¯·æŸ¥çœ‹ [å¿«é€Ÿå…¥é—¨æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/QUICKSTART.md)
          
          ### âš™ï¸ ç³»ç»Ÿè¦æ±‚
          
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - Ubuntu 20.04+ / å…¶ä»–Linuxå‘è¡Œç‰ˆ
          - macOS 10.15+
          - Android 7.0+ (API 24+)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Windows Releaseæ„å»º
  release-windows:
    needs: create-release
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: æ„å»ºWindows
      run: |
        flutter pub get
        flutter pub run build_runner build --delete-conflicting-outputs
        
        cd native/windows
        mkdir build
        cd build
        cmake .. -A x64
        cmake --build . --config Release
        copy Release\input_simulator_windows.dll ..\..\..
        cd ..\..\..\
        
        flutter build windows --release
        
        mkdir release_windows
        xcopy /E /I /Y build\windows\runner\Release\* release_windows\
        copy README.md release_windows\
        copy QUICKSTART.md release_windows\
        copy LICENSE release_windows\ 2>nul || echo No LICENSE file
    
    - name: å‹ç¼©WindowsåŒ…
      run: |
        Compress-Archive -Path release_windows\* -DestinationPath universal_remote_control_windows_v${{ needs.create-release.outputs.version }}.zip
    
    - name: ä¸Šä¼ Windows Release
      uses: softprops/action-gh-release@v1
      with:
        files: universal_remote_control_windows_v${{ needs.create-release.outputs.version }}.zip
        tag_name: v${{ needs.create-release.outputs.version }}
        draft: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Linux Releaseæ„å»º
  release-linux:
    needs: create-release
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libx11-dev libxtst-dev libxext-dev
    
    - name: è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: æ„å»ºLinux
      run: |
        flutter pub get
        flutter pub run build_runner build --delete-conflicting-outputs
        
        cd native/linux
        mkdir build
        cd build
        cmake ..
        make -j$(nproc)
        cp libinput_simulator_linux.so ../../..
        cd ../../..
        
        flutter build linux --release
        
        mkdir release_linux
        cp -r build/linux/x64/release/bundle/* release_linux/
        cp README.md release_linux/
        cp QUICKSTART.md release_linux/
        cp LICENSE release_linux/ 2>/dev/null || true
        
        cat > release_linux/run.sh << 'EOF'
        #!/bin/bash
        cd "$(dirname "$0")"
        export LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH
        ./universal_remote_control
        EOF
        chmod +x release_linux/run.sh
    
    - name: å‹ç¼©LinuxåŒ…
      run: |
        tar -czf universal_remote_control_linux_v${{ needs.create-release.outputs.version }}.tar.gz -C release_linux .
    
    - name: ä¸Šä¼ Linux Release
      uses: softprops/action-gh-release@v1
      with:
        files: universal_remote_control_linux_v${{ needs.create-release.outputs.version }}.tar.gz
        tag_name: v${{ needs.create-release.outputs.version }}
        draft: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # macOS Releaseæ„å»º
  release-macos:
    needs: create-release
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: æ„å»ºmacOS
      run: |
        flutter pub get
        flutter pub run build_runner build --delete-conflicting-outputs
        
        cd native/macos
        mkdir build
        cd build
        cmake ..
        make -j$(sysctl -n hw.ncpu)
        cp libinput_simulator_macos.dylib ../../..
        cd ../../..
        
        flutter build macos --release
        
        mkdir release_macos
        cp -r build/macos/Build/Products/Release/universal_remote_control.app release_macos/
        cp README.md release_macos/
        cp QUICKSTART.md release_macos/
        cp LICENSE release_macos/ 2>/dev/null || true
    
    - name: å‹ç¼©macOSåŒ…
      run: |
        cd release_macos
        zip -r ../universal_remote_control_macos_v${{ needs.create-release.outputs.version }}.zip .
    
    - name: ä¸Šä¼ macOS Release
      uses: softprops/action-gh-release@v1
      with:
        files: universal_remote_control_macos_v${{ needs.create-release.outputs.version }}.zip
        tag_name: v${{ needs.create-release.outputs.version }}
        draft: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Android Releaseæ„å»º
  release-android:
    needs: create-release
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: æ„å»ºAndroid
      run: |
        flutter pub get
        flutter pub run build_runner build --delete-conflicting-outputs
        flutter build apk --release
        mv build/app/outputs/flutter-apk/app-release.apk universal_remote_control_v${{ needs.create-release.outputs.version }}.apk
    
    - name: ä¸Šä¼ Android APK
      uses: softprops/action-gh-release@v1
      with:
        files: universal_remote_control_v${{ needs.create-release.outputs.version }}.apk
        tag_name: v${{ needs.create-release.outputs.version }}
        draft: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

