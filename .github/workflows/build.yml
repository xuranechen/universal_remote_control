name: Build All Platforms

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # Windowsæž„å»º
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Flutterç‰ˆæœ¬æ£€æŸ¥
      run: flutter --version
    
    - name: å®‰è£…ä¾èµ–
      run: flutter pub get
    
    - name: ç”Ÿæˆä»£ç 
      run: flutter pub run build_runner build --delete-conflicting-outputs
    
    - name: ç¼–è¯‘WindowsåŽŸç”Ÿåº“
      run: |
        cd native/windows
        mkdir build
        cd build
        cmake .. -A x64
        cmake --build . --config Release
        copy Release\input_simulator_windows.dll ..\..\..
    
    - name: æž„å»ºWindowsåº”ç”¨
      run: flutter build windows --release
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        mkdir release_windows
        xcopy /E /I /Y build\windows\runner\Release\* release_windows\
        copy README.md release_windows\
        copy QUICKSTART.md release_windows\
    
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: windows-build
        path: release_windows/
        retention-days: 7

  # Linuxæž„å»º
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang \
          cmake \
          ninja-build \
          pkg-config \
          libgtk-3-dev \
          libx11-dev \
          libxtst-dev \
          libxext-dev
    
    - name: è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Flutterç‰ˆæœ¬æ£€æŸ¥
      run: flutter --version
    
    - name: å®‰è£…ä¾èµ–
      run: flutter pub get
    
    - name: ç”Ÿæˆä»£ç 
      run: flutter pub run build_runner build --delete-conflicting-outputs
    
    - name: ç¼–è¯‘LinuxåŽŸç”Ÿåº“
      run: |
        cd native/linux
        mkdir build
        cd build
        cmake ..
        make -j$(nproc)
        cp libinput_simulator_linux.so ../../..
    
    - name: æž„å»ºLinuxåº”ç”¨
      run: flutter build linux --release
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        mkdir release_linux
        cp -r build/linux/x64/release/bundle/* release_linux/
        cp README.md release_linux/
        cp QUICKSTART.md release_linux/
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > release_linux/run.sh << 'EOF'
        #!/bin/bash
        cd "$(dirname "$0")"
        export LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH
        ./universal_remote_control
        EOF
        chmod +x release_linux/run.sh
    
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: linux-build
        path: release_linux/
        retention-days: 7

  # macOSæž„å»º
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Flutterç‰ˆæœ¬æ£€æŸ¥
      run: flutter --version
    
    - name: å®‰è£…ä¾èµ–
      run: flutter pub get
    
    - name: ç”Ÿæˆä»£ç 
      run: flutter pub run build_runner build --delete-conflicting-outputs
    
    - name: ç¼–è¯‘macOSåŽŸç”Ÿåº“
      run: |
        cd native/macos
        mkdir build
        cd build
        cmake ..
        make -j$(sysctl -n hw.ncpu)
        cp libinput_simulator_macos.dylib ../../..
    
    - name: æž„å»ºmacOSåº”ç”¨
      run: flutter build macos --release
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        mkdir release_macos
        cp -r build/macos/Build/Products/Release/universal_remote_control.app release_macos/
        cp README.md release_macos/
        cp QUICKSTART.md release_macos/
    
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: macos-build
        path: release_macos/
        retention-days: 7

  # Androidæž„å»º
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Flutterç‰ˆæœ¬æ£€æŸ¥
      run: flutter --version
    
    - name: å®‰è£…ä¾èµ–
      run: flutter pub get
    
    - name: ç”Ÿæˆä»£ç 
      run: flutter pub run build_runner build --delete-conflicting-outputs
    
    - name: æž„å»ºAndroid APK
      run: flutter build apk --release
    
    - name: æž„å»ºAndroid App Bundle
      run: flutter build appbundle --release
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        mkdir release_android
        cp build/app/outputs/flutter-apk/app-release.apk release_android/UniversalRemoteControl.apk
        cp build/app/outputs/bundle/release/app-release.aab release_android/UniversalRemoteControl.aab
        cp README.md release_android/
        cp QUICKSTART.md release_android/
    
    - name: ä¸Šä¼ APK
      uses: actions/upload-artifact@v3
      with:
        name: android-apk
        path: release_android/UniversalRemoteControl.apk
        retention-days: 7
    
    - name: ä¸Šä¼ App Bundle
      uses: actions/upload-artifact@v3
      with:
        name: android-bundle
        path: release_android/UniversalRemoteControl.aab
        retention-days: 7

  # æž„å»ºæ‘˜è¦
  build-summary:
    needs: [build-windows, build-linux, build-macos, build-android]
    runs-on: ubuntu-latest
    
    steps:
    - name: ç”Ÿæˆæž„å»ºæ‘˜è¦
      run: |
        echo "## ðŸŽ‰ æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æ‰€æœ‰å¹³å°æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ å¯ç”¨çš„æž„å»ºäº§ç‰©ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Windows (x64)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Linux (x64)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… macOS (Universal)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Android (APK + AAB)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½æ–¹å¼ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "åœ¨Actionsé¡µé¢çš„Artifactséƒ¨åˆ†ä¸‹è½½å¯¹åº”å¹³å°çš„æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY

